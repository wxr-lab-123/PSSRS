# PSSRS 医院挂号系统概要设计说明书

## E.1 引言

### E.1.1 编写目的
本文档旨在为PSSRS（Patient Self-Service Registration System）医院挂号系统提供宏观架构设计与功能蓝图。
预期的读者包括：
- 项目经理：了解系统整体架构与开发边界。
- 系统架构师：作为详细设计与技术选型的依据。
- 开发人员：理解系统模块划分与接口交互逻辑。
- 测试人员：制定系统测试策略与用例。

### E.1.2 背景
a. **待开发软件系统的名称**：PSSRS 医院挂号系统 (Patient Self-Service Registration System)
b. **任务提出者**：医院信息化建设委员会
   **开发者**：开发团队
   **用户**：
    - 患者（通过微信小程序）
    - 医生（通过Web工作台）
    - 医院管理员（通过Web后台）
   **运行中心**：医院数据中心或云服务器集群

### E.1.3 定义
- **RBAC** (Role-Based Access Control)：基于角色的访问控制。
- **WebSocket**：一种在单个TCP连接上进行全双工通信的协议，用于实时消息推送。
- **脱敏**：对敏感数据（如身份证号）进行部分隐藏处理。

### E.1.4 参考资料
- 《PSSRS 医院挂号系统需求规格说明书》
- 《PSSRS 系统功能说明书》
- 微信小程序开发文档
- Vue 3 + Vite 开发指南

## E.2 总体设计

### E.2.1 需求规定
系统需支持以下核心业务流程：
- **输入**：患者信息、挂号请求、医生排班设置、支付确认信息等。
- **输出**：挂号单、排队号、排班表、统计报表、审批结果通知。
- **功能性能**：
    - 支持高并发挂号请求（如专家号抢号）。
    - 数据实时性要求高（号源状态需秒级同步）。
    - 系统可用性需达到 99.9%。

### E.2.2 运行环境
- **客户端**：
    - 患者端：微信小程序（iOS/Android）。
    - 医生/管理端：现代浏览器（Chrome/Edge/Firefox）。
- **服务端**：
    - 操作系统：Linux (CentOS/Ubuntu) / Windows Server。
    - 运行环境：Java Runtime Environment (JRE) 17+。
    - 数据库：MySQL 8.0+。
    - 缓存：Redis 6.0+。

### E.2.3 基本设计概念和处理流程
系统采用 **前后端分离** 架构。
1.  **用户交互层**：通过小程序或Web页面发起请求。
2.  **网关/API层**：处理路由、鉴权与限流。
3.  **业务逻辑层**：处理挂号、排班、订单等核心业务。
4.  **数据持久层**：MySQL存储结构化数据，Redis处理热点数据（如剩余号源）。

**核心流程示例（挂号）**：
用户查询排班 -> 选择医生/时段 -> 锁定号源(Redis) -> 创建订单(MySQL) -> 支付 -> 支付成功 -> 更新号源状态 -> 生成挂号单。

### E.2.4 结构
系统划分为三个主要子系统：

1.  **患者端子系统 (WeChat Mini Program)**
    - 用户模块（注册/登录/个人中心）
    - 就诊人模块（添加/编辑/列表）
    - 挂号模块（预约/当日/取号）
    - 订单模块（列表/支付/详情）

2.  **医生工作台子系统 (Web)**
    - 排班模块（查看/请假）
    - 接诊模块（患者列表/状态更新）
    - 个人中心（信息维护）

3.  **管理后台子系统 (Web)**
    - 基础数据（科室/医生/排班）
    - 业务管理（挂号/订单/退款）
    - 系统管理（用户/角色/权限/日志）
    - 统计分析（仪表盘）

### E.2.6 人工处理过程
- **线下退费**：部分特殊情况下的退费可能需财务线下处理后在系统录入。
- **号源调整**：紧急停诊需管理员人工干预排班数据。

### E.2.7 尚未解决的问题
- 暂未集成医保支付接口。
- 暂未对接医院HIS系统（Hospital Information System）进行电子病历同步。

## E.3 接口设计

### E.3.1 用户接口
- **CLI/GUI**：
    - 小程序：遵循微信设计规范，采用蓝白配色，卡片式布局。
    - Web端：采用 Element Plus UI 框架，支持列表/卡片视图切换。
- **反馈信息**：所有操作均有明确的 Toast 提示（成功/失败/加载中）。

### E.3.2 外部接口
- **微信支付API**：用于挂号费支付。
- **短信网关API**：用于发送验证码和通知短信。
- **WebSocket服务**：用于向Web端推送实时通知（如新请假申请）。

### E.3.3 内部接口
- **RESTful API**：前后端交互采用标准 HTTP/HTTPS 协议，JSON 格式数据传输。
- **Redis 接口**：用于号源扣减的原子操作。

## E.4 运行设计

### E.4.1 运行模块组合
- **常规模式**：所有模块正常运行。
- **维护模式**：仅开放查询功能，挂号与支付功能暂停。

### E.4.2 运行控制
- 通过管理后台的“系统设置”模块进行全局参数配置（如每日放号时间）。
- 使用 Nginx 进行反向代理和负载均衡控制。

### E.4.3 运行时间
- 核心业务（挂号、支付）响应时间 < 500ms。
- 报表查询响应时间 < 3s。

## E.5 数据库设计

### E.5.1 概念结构设计
主要实体包括：
- **用户 (User)**：账号、密码、手机号。
- **就诊人 (Patient)**：姓名、身份证、关系。
- **医生 (Doctor)**：姓名、职称、科室。
- **排班 (Schedule)**：日期、时段、号源数。
- **订单 (Order)**：订单号、金额、状态。

### E.5.2 逻辑结构设计
核心表结构设计：
- `doctor_schedule`: 存储排班信息及剩余号源。
- `registrations`: 存储挂号记录。
- `orders`: 存储支付订单。
- `leave_request`: 存储医生请假申请。
- `system_settings`: 存储系统全局配置。

### E.5.3 物理结构设计
- 数据库采用 InnoDB 引擎，支持事务。
- 对高频查询字段（如 `doctor_id`, `schedule_date`, `status`）建立索引。
- 读写分离（未来扩展规划）。

## E.6 系统出错处理设计

### E.6.1 出错信息
- **前端**：网络异常、服务器错误（500）、请求参数错误（400）均有统一的错误提示页或弹窗。
- **后端**：统一异常处理（GlobalExceptionHandler），返回标准 JSON 格式错误码和消息。

### E.6.2 补救措施
a. **后备技术**：数据库每日定时全量备份，Binlog 实时增量备份。
b. **降效技术**：Redis 故障时，自动降级查数据库（可能影响并发性能但保证功能可用）。
c. **恢复及再启动**：应用服务采用 Docker 容器化部署，支持自动重启（Restart Policy）。

### E.6.3 系统维护设计
- **日志系统**：集成 Logback，记录操作日志 (`operation_log` 表) 和系统运行日志。
- **健康检查**：提供 `/actuator/health` 接口供监控系统调用。
- **热更新**：前端静态资源部署在 Nginx，后端支持平滑重启。
